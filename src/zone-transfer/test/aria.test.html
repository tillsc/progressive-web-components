<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>zone-transfer: aria</title>
    <script type="module" src="../../../dist/zone-transfer.js"></script>
</head>

<body>

<h1>zone-transfer: aria</h1>

<h2>ARIA roles, labels, and live region announcements</h2>

<pwc-zone-transfer id="zt">
    <pwc-zone-transfer-zone name="alpha" data-pwc-zone-hotkey="1">
        <pwc-zone-transfer-item id="a1">Item A1</pwc-zone-transfer-item>
        <pwc-zone-transfer-item id="a2">Item A2</pwc-zone-transfer-item>
        <pwc-zone-transfer-item id="a3">Item A3</pwc-zone-transfer-item>
    </pwc-zone-transfer-zone>

    <pwc-zone-transfer-zone name="beta" data-pwc-zone-hotkey="2">
        <pwc-zone-transfer-item id="b1">Item B1</pwc-zone-transfer-item>
    </pwc-zone-transfer-zone>
</pwc-zone-transfer>

<style>
    pwc-zone-transfer-zone {
        display: block; border: 1px solid #999;
        padding: 0.4rem; margin: 0.8rem; min-height: 2rem;
    }
    pwc-zone-transfer-item {
        display: block; padding: 0.2rem 0.3rem;
        border: 1px solid #ddd; margin: 0.2rem 0;
    }
    /* Debug: make the visually-hidden live region visible */
    pwc-zone-transfer [aria-live] {
        position: static !important;
        width: auto !important; height: auto !important;
        padding: 0.3rem 0.6rem !important; margin: 0.8rem !important;
        overflow: visible !important;
        clip: unset !important; white-space: normal !important;
        border: 2px dashed hotpink !important;
        font-weight: bold !important;
    }
    pwc-zone-transfer [aria-live]::before {
        content: "Live region: ";
        font-weight: normal; color: hotpink;
    }
</style>

<script type="module">
  import { run } from "../../../static/testing/harness.js";
  import { key } from "../../../static/testing/helpers.js";
  import * as assert from "../../../static/testing/assert.js";

  run(async ({ waitFor, log, nextTick }) => {
    const el = document.getElementById("zt");
    assert.ok(el, "missing <pwc-zone-transfer>");

    const zoneA = el.querySelector('[name="alpha"]');
    const zoneB = el.querySelector('[name="beta"]');
    assert.ok(zoneA && zoneB, "missing zones");

    // --- Zones: role and aria-label ---

    await log("zones have role=listbox");
    assert.attr(zoneA, "role", "listbox");
    assert.attr(zoneB, "role", "listbox");

    await log("zones have aria-label from name attribute");
    assert.attr(zoneA, "aria-label", "alpha");
    assert.attr(zoneB, "aria-label", "beta");

    // --- Items: role ---

    await log("items have role=option");
    const items = el.querySelectorAll("pwc-zone-transfer-item");
    for (const item of items) {
      assert.attr(item, "role", "option");
    }

    // --- Live region: keyboard reorder ---

    const a2 = zoneA.querySelector("#a2");
    a2.tabIndex = 0;
    a2.focus();
    await nextTick("after focus");

    await log("keyboard reorder announces position");
    key(a2, "ArrowDown", { ctrlKey: true });
    await nextTick("after reorder");

    const liveRegion = el.querySelector("[aria-live]");
    assert.ok(liveRegion, "live region exists");
    assert.attr(liveRegion, "aria-live", "assertive");
    assert.attr(liveRegion, "aria-atomic", "true");
    assert.attr(liveRegion, "role", "status");

    await log("live region shows position number after reorder");
    // a2 moved from index 1 to index 2 (0-based), so announcement is "3" (1-based)
    assert.equal(liveRegion.textContent, "3", "position announcement after reorder");

    // --- Live region: keyboard zone move ---

    await log("keyboard zone move announces zone name");
    a2.focus();
    await nextTick("after refocus");

    key(a2, "2"); // hotkey for zone beta
    await nextTick("after zone move");

    await waitFor(() => zoneB.querySelector("#a2"), { label: "a2 moved to beta" });
    assert.equal(liveRegion.textContent, "beta", "zone name announcement after move");

    await log("done");
  });
</script>
</body>
</html>
