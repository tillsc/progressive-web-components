<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>validity: basic</title>
    <script type="module" src="../../../dist/validity.js"></script>
    <style>
        :invalid { border-color: #c00; outline-color: #c00; }
        .pwc-validity-message { color: #c00; font-size: 0.85rem; }
    </style>
</head>

<body>

<h1>validity: basic</h1>

<h2>Initial validity</h2>

<pwc-validity id="v-initial">
    <label for="name">Name</label>
    <input id="name" data-pwc-validity="Name is required">
    <label for="role">Role</label>
    <select id="role" data-pwc-validity="Pick a role">
        <option value="">--</option>
        <option value="admin">Admin</option>
    </select>
    <label for="bio">Bio</label>
    <textarea id="bio" data-pwc-validity="Bio too short"></textarea>
    <label for="clean">Clean field</label>
    <input id="clean" placeholder="no error">
</pwc-validity>

<hr>

<h2>clear-on</h2>

<pwc-validity id="v-clear-on" clear-on="input">
    <label for="clear-on-input">Type to clear the error</label>
    <input id="clear-on-input" data-pwc-validity="Fix this">
</pwc-validity>

<hr>

<h2>clear-after</h2>

<pwc-validity id="v-clear-after" clear-after="50">
    <label for="clear-after-input">Error disappears after timeout</label>
    <input id="clear-after-input" data-pwc-validity="Goes away soon">
</pwc-validity>

<script type="module">
  import { run } from "../../../static/testing/harness.js";
  import * as assert from "../../../static/testing/assert.js";

  const msgOf = (el) => el.nextElementSibling?.matches(".pwc-validity-message") ? el.nextElementSibling : null;

  run(async ({ waitFor, log }) => {

    // --- Initial validity ---

    await log("initial: custom validity and message spans are set on connect");
    const name = document.getElementById("name");
    const role = document.getElementById("role");
    const bio = document.getElementById("bio");
    const clean = document.getElementById("clean");

    await waitFor(() => name.validationMessage, { label: "name has validation message" });
    assert.equal(name.validationMessage, "Name is required", "name message");
    assert.equal(msgOf(name)?.textContent, "Name is required", "name message span");
    assert.equal(role.validationMessage, "Pick a role", "role message");
    assert.equal(msgOf(role)?.textContent, "Pick a role", "role message span");
    assert.equal(bio.validationMessage, "Bio too short", "bio message");
    assert.equal(msgOf(bio)?.textContent, "Bio too short", "bio message span");
    assert.equal(clean.validationMessage, "", "clean input has no error");
    assert.equal(msgOf(clean), null, "clean input has no message span");

    // --- clear-on ---

    await log("clear-on: error and message span clear on input event");
    const clearOnInput = document.getElementById("clear-on-input");
    await waitFor(() => clearOnInput.validationMessage, { label: "clear-on has error" });
    assert.ok(msgOf(clearOnInput), "message span present before clear");

    clearOnInput.dispatchEvent(new Event("input", { bubbles: true }));
    await waitFor(() => !clearOnInput.validationMessage, { label: "clear-on error cleared" });
    assert.equal(clearOnInput.validationMessage, "", "error cleared after input event");
    assert.equal(msgOf(clearOnInput), null, "message span removed");

    // --- clear-after ---

    await log("clear-after: error cleared after timeout");
    const clearAfterInput = document.getElementById("clear-after-input");
    await waitFor(() => !clearAfterInput.validationMessage, { label: "clear-after error cleared" });
    assert.equal(clearAfterInput.validationMessage, "", "error cleared");
    assert.equal(msgOf(clearAfterInput), null, "message span removed");

    await log("done");
  });
</script>
</body>
</html>
