<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>multiselect-dual-list: dynamic options (chunking)</title>
  <script type="module" src="../../../dist/multiselect-dual-list.js"></script>
</head>
<body>

  <h1>multiselect-dual-list: dynamic options (chunking)</h1>

  <h2>Selection preserved when options are added dynamically</h2>

  <pwc-multiselect-dual-list id="demo" available-label="Available" selected-label="Selected">
    <select multiple name="items">
      <option value="a1">Alpha</option>
      <option value="a2" selected>Bravo</option>
      <option value="a3">Charlie</option>
      <option value="a4">Delta</option>
    </select>
  </pwc-multiselect-dual-list>

  <script type="module">
    import { run } from "../../../static/testing/harness.js";
    import { click } from "../../../static/testing/helpers.js";

    run(async ({ assert, equal, waitFor, log }) => {
      const host = document.getElementById("demo");
      await waitFor(() => host.querySelector(".pwc-multiselect-dual-list-container"), { label: "container rendered" });

      const container = host.querySelector(".pwc-multiselect-dual-list-container");
      const select = host.querySelector("select");

      // Modify selection before chunking: select a1, deselect a2
      await log("modifying selection before chunking");
      click(container.querySelector("[data-value='a1'] [data-action='add']"));
      click(container.querySelector(".pwc-multiselect-dual-list-selected [data-value='a2'] [data-action='remove']"));
      await waitFor(
        () => container.querySelectorAll(".pwc-multiselect-dual-list-selected [data-value]").length === 1,
        { label: "selection modified" }
      );

      // Simulate chunking: append new options
      await log("appending new options");
      for (const [value, text, selected] of [["b1", "Echo", false], ["b2", "Foxtrot", true], ["b3", "Golf", false]]) {
        const el = document.createElement("option");
        el.value = value;
        el.textContent = text;
        el.selected = selected;
        select.appendChild(el);
      }

      // Wait for observer to rebuild
      await waitFor(
        () => container.querySelectorAll(".pwc-multiselect-dual-list-available [data-value]").length === 7,
        { label: "new options rendered" }
      );

      // Existing selection preserved
      await log("checking selection preserved");
      assert(container.querySelector(".pwc-multiselect-dual-list-selected [data-value='a1']"), "a1 still selected");
      assert(!container.querySelector(".pwc-multiselect-dual-list-selected [data-value='a2']"), "a2 still deselected");

      // New options placed correctly
      await log("checking new options placement");
      assert(!container.querySelector(".pwc-multiselect-dual-list-selected [data-value='b1']"), "b1 not selected");
      assert(container.querySelector(".pwc-multiselect-dual-list-selected [data-value='b2']"), "b2 selected");
      assert(!container.querySelector(".pwc-multiselect-dual-list-selected [data-value='b3']"), "b3 not selected");

      equal(container.querySelectorAll(".pwc-multiselect-dual-list-selected [data-value]").length, 2, "2 selected (a1 + b2)");

      await log("done");
    });
  </script>
</body>
</html>
