<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>multiselect-dual-list: filter API (pwc-filter composition)</title>
  <script type="module" src="../../../dist/filter.js"></script>
  <script type="module" src="../../../dist/multiselect-dual-list.js"></script>
</head>
<body>

  <h1>multiselect-dual-list: filter API</h1>

  <h2>Composition with pwc-filter</h2>

  <pwc-multiselect-dual-list id="demo" available-label="Available" selected-label="Selected">
    <select multiple name="items">
      <option value="1">Alpha</option>
      <option value="2">Bravo</option>
      <option value="3">Charlie</option>
      <option value="4" selected>Delta</option>
    </select>
  </pwc-multiselect-dual-list>

  <script type="module">
    import { run } from "../../../static/testing/harness.js";

    run(async ({ assert, equal, waitFor, log }) => {
      const host = document.getElementById("demo");
      await waitFor(() => host.querySelector(".pwc-msdl-container"), { label: "container rendered" });

      assert(host.filter, "host.filter returns pwc-filter element");

      let lastEvent = null;
      host.addEventListener("pwc-filter:change", (e) => { lastEvent = e; });

      // --- filterText getter/setter + event ---
      await log("filterText property on pwc-filter");
      equal(host.filter.filterText, "", "filterText is empty initially");

      host.filter.filterText = "alpha";
      equal(host.filter.filterText, "alpha", "getter returns set value");
      assert(lastEvent, "pwc-filter:change event dispatched");
      equal(lastEvent.detail.filterText, "alpha", "detail.filterText");
      equal(lastEvent.detail.matchCount, 1, "matchCount 1");
      equal(lastEvent.detail.totalCount, 4, "totalCount 4");

      // --- matchCount = 0 ---
      await log("no-match case");
      host.filter.filterText = "zzz-no-match";
      equal(lastEvent.detail.matchCount, 0, "matchCount 0 for no-match");

      // --- Filter re-applied after dynamic option change ---
      await log("filter persistence across rebuild");
      host.filter.filterText = "alpha";

      const opt = document.createElement("option");
      opt.value = "5";
      opt.textContent = "Alpha Two";
      host.select.appendChild(opt);

      await waitFor(
        () => host.querySelectorAll(".pwc-msdl-available [data-value]").length === 5,
        { label: "new option rendered" }
      );

      equal(lastEvent.detail.matchCount, 2, "matchCount 2 after adding Alpha Two");
      equal(lastEvent.detail.totalCount, 5, "totalCount 5 after rebuild");

      await log("done");
    });
  </script>
</body>
</html>
