<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>include: advanced</title>
    <script type="module" src="../../../dist/include.js"></script>
</head>

<body>

<h1>include: advanced</h1>

<h2>extract-styles without shadow (adopts to document)</h2>

<pwc-include id="extract-styles" src="./styled-fragment.html" extract-styles></pwc-include>

<hr>

<h2>alt (fallback)</h2>

<div id="alt-wrapper"></div>

<hr>

<h2>Error event</h2>

<div id="error-wrapper"></div>

<hr>

<h2>Dynamic src change</h2>

<pwc-include id="dynamic"></pwc-include>

<hr>

<h2>refresh()</h2>

<pwc-include id="refreshable" src="./fragment.html"></pwc-include>

<script type="module">
  import { run } from "../../../static/testing/harness.js";
  import { waitForEvent } from "../../../static/testing/helpers.js";

  run(async ({ assert, equal, waitFor, log, suppressErrors }) => {

    // --- extract-styles  ---

    await log("extract-styles: styles go to document.adoptedStyleSheets");
    const noShadow = document.getElementById("extract-styles");
    await waitFor(() => noShadow.querySelector(".styled"), { label: "extract-styles content loaded" });
    assert(!noShadow.querySelector("style"), "no <style> element in DOM");
    const docSheets = document.adoptedStyleSheets;
    assert(docSheets.length > 0, "document has adoptedStyleSheets");

    // --- alt (fallback) ---

    await log("alt: fallback on primary error");
    await suppressErrors("404", async () => {
      const altEl = document.createElement("pwc-include");
      altEl.setAttribute("src", "./does-not-exist.html");
      altEl.setAttribute("alt", "./fragment.html");
      document.getElementById("alt-wrapper").appendChild(altEl);
      await waitFor(() => altEl.querySelector(".greeting"), { label: "alt content loaded" });
      assert(altEl.querySelector(".greeting"), "fallback content loaded from alt");
    });

    // --- Error event ---

    await log("error: fires pwc-include:error on failure");
    await suppressErrors("404", async () => {
      const errorEl = document.createElement("pwc-include");
      const eventPromise = waitForEvent(errorEl, "pwc-include:error");
      errorEl.setAttribute("src", "./does-not-exist.html");
      document.getElementById("error-wrapper").appendChild(errorEl);
      const e = await eventPromise;
      assert(e.detail.error, "error event has detail.error");
      assert(e.detail.error.message.includes("404"), "error message contains status code");
    });

    // --- Dynamic src change ---

    await log("dynamic: setting src triggers fetch");
    const dynamic = document.getElementById("dynamic");
    assert(!dynamic.querySelector(".greeting"), "no content before src is set");
    dynamic.setAttribute("src", "./fragment.html");
    await waitFor(() => dynamic.querySelector(".greeting"), { label: "dynamic content loaded" });
    assert(dynamic.querySelector(".greeting"), "content loaded after src change");

    // --- refresh() ---

    await log("refresh: re-fetches content");
    const refreshable = document.getElementById("refreshable");
    await waitFor(() => refreshable.querySelector(".greeting"), { label: "refreshable initial load" });
    const loadPromise = waitForEvent(refreshable, "pwc-include:load");
    refreshable.refresh();
    await loadPromise;
    assert(refreshable.querySelector(".greeting"), "content present after refresh");

    await log("done");
  });
</script>
</body>
</html>
