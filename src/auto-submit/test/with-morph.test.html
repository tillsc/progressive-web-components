<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>auto-submit: with-morph</title>
  <script type="module" src="../../../dist/auto-submit.js"></script>
  <style>
      pwc-auto-submit[aria-busy="true"] { opacity: 0.5; }
  </style>
</head>

<body>

<h1>auto-submit: with-morph</h1>


<pwc-auto-submit id="as-backend" local-reload>
  <form method="get" action="/src/auto-submit/test/backend/form">
    <label for="first">First</label><br>
    <input id="first" name="first" value="Alice"><br><br>
    <label for="last">Last (with <code>data-auto-submit</code>)</label><br>
    <input id="last" name="last" value="Smith" data-auto-submit><br><br>
    <label for="color">Color</label><br>
    <input id="color" name="color" value="red">
  </form>
</pwc-auto-submit>

<script type="module">
  import { run } from "../../../static/testing/harness.js";
  import { setValue, waitForEvent } from "../../../static/testing/helpers.js";
  import { Idiomorph } from 'https://cdn.jsdelivr.net/npm/idiomorph@0.7.4/+esm';

  const morphFn = (target, content) => {
    Idiomorph.morph(target, content, {
      morphStyle: "innerHTML",
      restoreFocus: true,
      callbacks: {
        beforeAttributeUpdated(attributeName, node, _mutationType) {
          if (
            node instanceof HTMLInputElement ||
            node instanceof HTMLTextAreaElement ||
            node instanceof HTMLSelectElement
          ) {
            if (!node.isConnected) return true

            if (attributeName === "value" || attributeName === "checked") {
              return false
            }
          }

          return true
        }
      }
    })
  }

  document.addEventListener("context-request", (e) => {
    if (e.context === "morph") e.callback(morphFn);
  });

  run(async ({ assert, equal, waitFor, log }) => {

    const el = document.getElementById("as-backend");

    await log("precondition: initial values");
    equal(el.querySelector("#first").value, "Alice", "first");
    equal(el.querySelector("#last").value, "Smith", "last");
    equal(el.querySelector("#color").value, "red", "color");

    await log("change last â†’ triggers auto-submit");
    const loadPromise = waitForEvent(el, "pwc-auto-submit:load");
    setValue(el.querySelector("#last"), "Jones");
    el.querySelector("#color").focus();
    setValue(el.querySelector("#color"), "blue"); // Should not get lost even if it can not be part of the backend's response
    await loadPromise;

    await log("after transclusion: server echoed submitted values");
    equal(el.querySelector("#first").value, "Alice", "first unchanged (submitted as-is)");
    equal(el.querySelector("#last").value, "Jones", "last has new value");
    assert(document.activeElement == el.querySelector("#color"), "color input still has the focus");
    equal(el.querySelector("#color").value, "blue", "color not reset to server value (local change not lost)");

    await log("done");
  });
</script>
</body>
</html>
