<!-- src/dialog-opener/test/click-opens-dialog.html -->
<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dialog-opener: click opens dialog</title>
  <script type="module" src="../../../dist/dialog-opener.js"></script>
  <style>
    #dialog-opener-demo {
      display: block;
      border: 1px solid #999;
      padding: 0.8rem;
      margin: 0.8rem 0;
    }
  </style>
</head>

<body>

  <h1>dialog-opener: basic</h1>

  <h2>Click opens dialog with iframe</h2>

  <p>Clicking the "Open" link opens a dialog with an iframe loading <a href="./iframe-target.html"><code>iframe-target.html</code></a>.
  The form inside submits via GET back to this page (simulating a server round-trip).
  This page then adds <code>?pwc_done_with=ok</code> via JS redirect â€” normally the server
  would do this after processing the form. The component detects that parameter, closes
  the dialog, and reloads the opener content with the new values.</p>

  <pwc-dialog-opener id="dialog-opener-demo" hoist-actions="submit" local-reload="with-scripts replace-url">
    <a href="./iframe-target.html">Open</a><br>
    Hello <span id="first_name"></span> <span id="last_name"></span>
    <input type="hidden" name="default_for_iframe_target">
    <script type="module">
      const url = new URL(window.location.href);
      const firstName = url.searchParams.get("first_name") || "";
      const lastName = url.searchParams.get("last_name") || "";
      document.getElementById("first_name").textContent = firstName
      document.getElementById("last_name").textContent = lastName
      document.querySelector("input[name=default_for_iframe_target]").value = JSON.stringify({firstName , lastName});
    </script>
  </pwc-dialog-opener>

  <script type="module">
    import { run } from "../../../static/test-harness.js";
    
    const u = new URL(window.location.href);
    if (u.searchParams.has("commit")) {
      // IFrame submission mode
      if (!u.searchParams.has("pwc_done_with")) {
        // Simulate server redirect (see explanation above)
        u.searchParams.set("pwc_done_with", "ok");
        window.location.replace(u.toString());
      }
    }
    else {
      run(async ({ assert, equal, waitFor, nextTick, log }) => {
        await log("checking element definition");
        assert(customElements.get("pwc-dialog-opener"), "pwc-dialog-opener not defined");

        const el = document.querySelector("#dialog-opener-demo");
        assert(el, "missing pwc-dialog-opener");

        const link = el.querySelector("a");
        assert(link, "missing link");

        await log("clicking link");
        link.dispatchEvent(
          new MouseEvent("click", { bubbles: true, cancelable: true, composed: true })
        );
        await nextTick();

        await log("waiting for dialog to exist");
        await waitFor(() => Boolean(document.querySelector("dialog.pwc-modal-dialog")), {
          message: "dialog not created"
        });

        const dlg = document.querySelector("dialog.pwc-modal-dialog");
        assert(dlg, "dialog missing");

        await log("waiting for dialog to be open");
        await waitFor(() => dlg.open === true, { message: "dialog did not open" });

        await log("checking iframe exists");
        const iframe = dlg.querySelector("iframe");
        assert(iframe, "iframe not created");

        await log("waiting for iframe load");
        await waitFor(() => {
          return iframe.contentDocument && iframe.contentDocument.readyState === "complete";
        }, { timeoutMs: 10_000, message: "iframe did not load" });

        await log("checking iframe src has _layout=false");
        {
          const raw = iframe.getAttribute("src") || "";
          const u = new URL(raw, window.location.href);
          assert(u.pathname.endsWith("/src/dialog-opener/test/iframe-target.html"), `unexpected iframe pathname: ${u.pathname}`);
          assert(u.searchParams.get("pwc_embedded") === "true", `missing or wrong pwc_embedded param: ${u.search}`);
        }

        await log("waiting for moved-out OK button");
        await waitFor(() => {
          const btn = dlg.querySelector(".pwc-dialog-opener-actions button[type=submit]");
          return Boolean(btn);
        }, { timeoutMs: 10_000, message: "moved-out submit button not found" });

        const okBtn = dlg.querySelector(".pwc-dialog-opener-actions button[type=submit]");
        assert(okBtn, "moved-out submit button missing");

        await log("clicking moved-out OK button");
        okBtn.dispatchEvent(
          new MouseEvent("click", { bubbles: true, cancelable: true, composed: true })
        );

        await log("waiting for dialog to close after redirect");
        await waitFor(() => dlg.open === false, { timeoutMs: 10_000, message: "dialog did not close after OK" });

        equal(document.querySelectorAll("pwc-modal-dialog").length, 1, "modal-dialog element should persist for reuse");
      });
    }
  </script>
</body>

</html>