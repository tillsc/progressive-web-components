<!-- src/dialog-opener/test/click-opens-dialog.html -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>dialog-opener: click opens dialog</title>
    <script type="module" src="../../../dist/dialog-opener.js"></script>
  </head>
  <body>
    <pwc-dialog-opener id="do1">
      <a href="./iframe-target.html">Open</a>
    </pwc-dialog-opener>

    <script type="module">
      import { run } from "../../../test/static/harness.js";

      run(async ({ assert, equal, waitFor, nextTick, log }) => {
        log("checking element definition");
        assert(customElements.get("pwc-dialog-opener"), "pwc-dialog-opener not defined");

        const el = document.querySelector("#do1");
        assert(el, "missing pwc-dialog-opener");

        const link = el.querySelector("a");
        assert(link, "missing link");

        log("clicking link");
        link.dispatchEvent(
          new MouseEvent("click", { bubbles: true, cancelable: true, composed: true })
        );
        await nextTick();

        log("waiting for dialog to exist");
        await waitFor(() => Boolean(document.querySelector("dialog.pwc-dialog-opener-modal")), {
          message: "dialog not created"
        });

        const dlg = document.querySelector("dialog.pwc-dialog-opener-modal");
        assert(dlg, "dialog missing");

        log("waiting for dialog to be open");
        await waitFor(() => dlg.open === true, { message: "dialog did not open" });

        log("checking iframe exists");
        const iframe = dlg.querySelector("iframe");
        assert(iframe, "iframe not created");

        log("waiting for iframe load");
        await waitFor(() => {
          return iframe.contentDocument && iframe.contentDocument.readyState === "complete";
        }, { timeoutMs: 10_000, message: "iframe did not load" });

        log("checking iframe src is correct");
        const src = iframe.getAttribute("src") || "";
        assert(
          src.endsWith("iframe-target.html?_layout=false"),
          `unexpected iframe src: ${src}`
        );

        log("closing dialog");
        dlg.close();

        await waitFor(() => dlg.open === false, { message: "dialog did not close" });

        equal(
          document.querySelectorAll("dialog.pwc-dialog-opener-modal").length,
          1,
          "unexpected dialog count"
        );
      });
    </script>
  </body>
</html>