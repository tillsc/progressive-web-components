<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>pwc-filter: basic</title>
    <script type="module" src="../../../dist/filter.js"></script>
</head>

<body>
<pwc-filter id="filter" debounce="0">
    <table>
        <tr data-pwc-filter-row><td>Alice</td><td>Anderson</td></tr>
        <tr data-pwc-filter-row><td>Bob</td><td>Brown</td></tr>
        <tr data-pwc-filter-row><td>Charlie</td><td>Chaplin</td></tr>
    </table>
</pwc-filter>

<script type="module">
  import { run } from "../../../static/test-harness.js";

  run(async ({ assert, equal, waitFor, log, nextTick }) => {
    await log("checking element definition");
    assert(customElements.get("pwc-filter"), "pwc-filter not defined");

    const el = document.getElementById("filter");
    assert(el, "missing <pwc-filter>");

    const rows = Array.from(el.querySelectorAll("[data-pwc-filter-row]"));
    equal(rows.length, 3, "expected 3 rows");

    const input = el.querySelector("input[type=search]");
    assert(input, "search input not created");

    await log("precondition: all rows visible");
    equal(rows.filter((r) => !r.hidden).length, 3, "expected all rows visible");

    await log("filtering for 'bob'");
    input.value = "bob";
    input.dispatchEvent(new Event("input", { bubbles: true }));

    await waitFor(() => rows.filter((r) => !r.hidden).length === 1, { label: "bob filtered" });
    equal(rows.find((r) => !r.hidden)?.textContent.trim(), "BobBrown", "expected Bob Brown to remain visible");

    await log("clearing filter");
    input.value = "";
    input.dispatchEvent(new Event("input", { bubbles: true }));

    await waitFor(() => rows.filter((r) => !r.hidden).length === 3, { label: "filter removed again" });

    await log("filtering via filterText setter");
    el.filterText = "charlie";
    equal(rows.filter((r) => !r.hidden).length, 1, "expected 1 row for charlie");
    equal(rows.find((r) => !r.hidden)?.textContent.trim(), "CharlieChaplin", "expected Charlie Chaplin");

    await log("pwc-filter:change event");
    let lastEvent = null;
    el.addEventListener("pwc-filter:change", (e) => (lastEvent = e));
    el.filterText = "bob";
    assert(lastEvent, "expected pwc-filter:change event");
    equal(lastEvent.detail.matchCount, 1, "matchCount should be 1");
    equal(lastEvent.detail.totalCount, 3, "totalCount should be 3");

    await log("clearing via filterText");
    el.filterText = "";
    equal(rows.filter((r) => !r.hidden).length, 3, "all rows visible after clearing");

    await log("applyFilter() re-evaluates after content change");
    el.filterText = "alice";
    equal(rows.filter((r) => !r.hidden).length, 1, "1 row for alice");
    // Change Bob's content to include "alice"
    rows[1].querySelector("td").textContent = "Alice-Bob";
    el.applyFilter();
    equal(rows.filter((r) => !r.hidden).length, 2, "2 rows match after content change and applyFilter()");

    await log("done");
  });
</script>
</body>
</html>