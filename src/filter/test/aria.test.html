<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>pwc-filter: aria</title>
    <script type="module" src="../../../dist/filter.js"></script>
</head>

<body>

<h1>pwc-filter: aria</h1>

<h2>Test 1: auto-created hidden status</h2>
<pwc-filter id="filter-auto" debounce="0" placeholder="Search items…">
    <table>
        <tr data-pwc-filter-row><td>Alice</td><td>Anderson</td></tr>
        <tr data-pwc-filter-row><td>Bob</td><td>Brown</td></tr>
        <tr data-pwc-filter-row><td>Charlie</td><td>Chaplin</td></tr>
    </table>
</pwc-filter>

<hr>

<h2>Test 2: user-provided status + input placeholder</h2>
<pwc-filter id="filter-custom" debounce="0">
    <h3>Results <span data-pwc-filter-status id="custom-status"></span></h3>
    <div data-pwc-filter-input id="custom-input-target"></div>
    <table>
        <tr data-pwc-filter-row><td>Dave</td><td>Davis</td></tr>
        <tr data-pwc-filter-row><td>Eve</td><td>Evans</td></tr>
    </table>
</pwc-filter>

<script type="module">
  import { run } from "../../../static/testing/harness.js";
  import { setValue } from "../../../static/testing/helpers.js";
  import * as assert from "../../../static/testing/assert.js";

  run(async ({ waitFor, log }) => {

    // === Auto-created hidden status ===

    const el = document.getElementById("filter-auto");
    assert.ok(el, "missing <pwc-filter> auto");

    const input = el.querySelector("input[type=search]");
    assert.ok(input, "search input not created");

    await log("input has aria-label from placeholder");
    assert.attr(input, "aria-label", "Search items…");

    await log("auto status region exists");
    const status = el.querySelector("[role=status]");
    assert.ok(status, "status region not found");
    assert.attr(status, "aria-live", "polite");
    assert.attr(status, "aria-atomic", "true");

    await log("status is empty before filtering");
    assert.equal(status.textContent, "", "status empty initially");

    await log("filtering for 'bob' updates auto status");
    setValue(input, "bob", { change: false });
    await waitFor(() => status.textContent !== "", { label: "status updated" });
    assert.equal(status.textContent, "1 / 3", "status shows 1 / 3");

    await log("clearing filter clears auto status");
    setValue(input, "", { change: false });
    await waitFor(() => status.textContent === "", { label: "status cleared" });

    // === User-provided visible status ===

    const el2 = document.getElementById("filter-custom");
    assert.ok(el2, "missing <pwc-filter> custom");

    const customStatus = document.getElementById("custom-status");
    assert.ok(customStatus, "custom status element exists");

    await log("input is inside the placeholder element");
    const inputTarget = document.getElementById("custom-input-target");
    const input2 = el2.querySelector("input[type=search]");
    assert.equal(input2.parentNode, inputTarget, "input is child of placeholder");

    await log("heading is before input in DOM order");
    const h3 = el2.querySelector("h3");
    const inputPos = input2.compareDocumentPosition(h3);
    assert.ok(inputPos & Node.DOCUMENT_POSITION_PRECEDING, "h3 precedes input");

    await log("user-provided status gets ARIA attributes");
    assert.attr(customStatus, "role", "status");
    assert.attr(customStatus, "aria-live", "polite");
    assert.attr(customStatus, "aria-atomic", "true");

    await log("user-provided status is NOT visually hidden");
    const cs = getComputedStyle(customStatus);
    assert.ok(cs.position !== "absolute" || cs.width !== "1px", "custom status is visible");

    await log("no extra hidden status element was created");
    const allStatuses = el2.querySelectorAll("[role=status]");
    assert.equal(allStatuses.length, 1, "only one status element");

    await log("filtering updates user-provided status");
    setValue(input2, "dave", { change: false });
    await waitFor(() => customStatus.textContent !== "", { label: "custom status updated" });
    assert.equal(customStatus.textContent, "1 / 2", "custom status shows 1 / 2");

    await log("clearing filter clears user-provided status");
    setValue(input2, "", { change: false });
    await waitFor(() => customStatus.textContent === "", { label: "custom status cleared" });

    await log("done");
  });
</script>
</body>
</html>
