<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>conditional-display: basic</title>
    <script type="module" src="../../../dist/conditional-display.js"></script>
</head>

<body>

<h1>conditional-display: basic</h1>

<h2>Select</h2>

<label for="payment">Payment method</label>
<select id="payment">
    <option value="card">Credit card</option>
    <option value="paypal">PayPal</option>
    <option value="invoice">Invoice</option>
</select>

<pwc-shown-if id="shown-card" selector="#payment" value="card">
    <p>shown-if (card): <input name="card_number" placeholder="Card number"></p>
</pwc-shown-if>

<pwc-hidden-if id="hidden-paypal" selector="#payment" value="paypal">
    <p>hidden-if (paypal): <input name="address" placeholder="Billing address"></p>
</pwc-hidden-if>

<pwc-enabled-if id="enabled-invoice" selector="#payment" value="invoice">
    <p>enabled-if (invoice): <input name="invoice_ref" placeholder="Reference"></p>
</pwc-enabled-if>

<pwc-disabled-if id="disabled-card" selector="#payment" value="card">
    <p>disabled-if (card): <input name="coupon" placeholder="Coupon"></p>
</pwc-disabled-if>

<hr>

<h2>Radio group (in form)</h2>

<form id="radio-form">
    <label><input type="radio" name="color" value="red"> Red</label>
    <label><input type="radio" name="color" value="green"> Green</label>
    <label><input type="radio" name="color" value="blue" checked> Blue</label>

    <pwc-shown-if id="shown-radio" selector="input[name=color]" value="red,green">
        <p>shown-if (red, green): <input name="warm_option" placeholder="Warm color option"></p>
    </pwc-shown-if>
</form>

<hr>

<h2>Checkbox without value</h2>

<label><input type="checkbox" id="agree"> I agree</label>
<pwc-shown-if id="shown-checkbox" selector="#agree">
    <p>shown-if (checked): <input name="extra" placeholder="Extra info"></p>
</pwc-shown-if>

<hr>

<h2>Checkbox with value</h2>

<label><input type="checkbox" id="color-check" value="red"> Red</label>
<pwc-shown-if id="shown-checkbox-val" selector="#color-check" value="red">
    <p>shown-if (red): <input name="red_option" placeholder="Red option"></p>
</pwc-shown-if>

<hr>

<h2>Pre-disabled input</h2>

<label for="pre-disabled-select">Section toggle</label>
<select id="pre-disabled-select">
    <option value="a">A (show)</option>
    <option value="b">B (hide)</option>
</select>
<pwc-shown-if id="shown-pre-disabled" selector="#pre-disabled-select" value="a">
    <p>Normal: <input name="normal_field" placeholder="Normal field"></p>
    <p>Always disabled: <input name="always_disabled" disabled placeholder="Always disabled"></p>
</pwc-shown-if>

<script type="module">
  import { run } from "../../../static/testing/harness.js";
  import { setValue, clickRadio, toggleCheckbox } from "../../../static/testing/helpers.js";
  import * as assert from "../../../static/testing/assert.js";

  run(async ({ waitFor, log }) => {

    await log("checking element definitions");
    assert.customElement("pwc-shown-if");
    assert.customElement("pwc-hidden-if");
    assert.customElement("pwc-enabled-if");
    assert.customElement("pwc-disabled-if");

    const payment = document.getElementById("payment");

    // --- pwc-shown-if with select ---

    await log("shown-if: initial state (card selected)");
    const shownCard = document.getElementById("shown-card");
    await waitFor(() => !shownCard.hidden, { label: "shown-card visible" });
    assert.equal(shownCard.hidden, false, "shown-card should be visible for card");

    await log("shown-if: switch to paypal");
    setValue(payment, "paypal");
    await waitFor(() => shownCard.hidden, { label: "shown-card hidden" });
    assert.equal(shownCard.querySelector("input").disabled, true, "contained input should be disabled when hidden");

    await log("shown-if: switch back to card");
    setValue(payment, "card");
    await waitFor(() => !shownCard.hidden, { label: "shown-card visible again" });
    assert.equal(shownCard.querySelector("input").disabled, false, "contained input should be re-enabled");

    // --- pwc-hidden-if with select ---

    await log("hidden-if: initial state (card selected)");
    const hiddenPaypal = document.getElementById("hidden-paypal");
    await waitFor(() => !hiddenPaypal.hidden, { label: "hidden-paypal visible" });

    await log("hidden-if: switch to paypal");
    setValue(payment, "paypal");
    await waitFor(() => hiddenPaypal.hidden, { label: "hidden-paypal hidden" });

    await log("hidden-if: switch to invoice");
    setValue(payment, "invoice");
    await waitFor(() => !hiddenPaypal.hidden, { label: "hidden-paypal visible again" });

    // --- pwc-enabled-if with select ---

    await log("enabled-if: initial state (invoice selected)");
    const enabledInvoice = document.getElementById("enabled-invoice");
    const invoiceInput = enabledInvoice.querySelector("input");
    await waitFor(() => !invoiceInput.disabled, { label: "invoice input enabled" });

    await log("enabled-if: switch to card");
    setValue(payment, "card");
    await waitFor(() => invoiceInput.disabled, { label: "invoice input disabled" });

    await log("enabled-if: switch back to invoice");
    setValue(payment, "invoice");
    await waitFor(() => !invoiceInput.disabled, { label: "invoice input enabled again" });

    // --- pwc-disabled-if with select ---

    await log("disabled-if: initial state (invoice selected)");
    const disabledCard = document.getElementById("disabled-card");
    const couponInput = disabledCard.querySelector("input");
    await waitFor(() => !couponInput.disabled, { label: "coupon enabled" });

    await log("disabled-if: switch to card");
    setValue(payment, "card");
    await waitFor(() => couponInput.disabled, { label: "coupon disabled" });

    // --- Radio group ---

    await log("radio: initial state (blue checked)");
    const shownRadio = document.getElementById("shown-radio");
    await waitFor(() => shownRadio.hidden, { label: "radio section hidden for blue" });

    await log("radio: click red");
    clickRadio(document.querySelector("input[name=color][value=red]"));
    await waitFor(() => !shownRadio.hidden, { label: "radio section visible for red" });

    await log("radio: click green (comma-separated value)");
    clickRadio(document.querySelector("input[name=color][value=green]"));
    await waitFor(() => !shownRadio.hidden, { label: "radio section visible for green" });

    await log("radio: click blue again");
    clickRadio(document.querySelector("input[name=color][value=blue]"));
    await waitFor(() => shownRadio.hidden, { label: "radio section hidden for blue again" });

    // --- Checkbox without value ---

    await log("checkbox (no value): initial state (unchecked)");
    const shownCb = document.getElementById("shown-checkbox");
    const agree = document.getElementById("agree");
    await waitFor(() => shownCb.hidden, { label: "checkbox section hidden" });

    await log("checkbox (no value): check");
    toggleCheckbox(agree);
    await waitFor(() => !shownCb.hidden, { label: "checkbox section visible" });

    await log("checkbox (no value): uncheck");
    toggleCheckbox(agree);
    await waitFor(() => shownCb.hidden, { label: "checkbox section hidden again" });

    // --- Checkbox with value ---

    await log("checkbox (with value): initial state (unchecked)");
    const shownCbVal = document.getElementById("shown-checkbox-val");
    const colorCheck = document.getElementById("color-check");
    await waitFor(() => shownCbVal.hidden, { label: "checkbox-val section hidden" });

    await log("checkbox (with value): check");
    toggleCheckbox(colorCheck);
    await waitFor(() => !shownCbVal.hidden, { label: "checkbox-val section visible" });

    // --- Pre-disabled input preserved ---

    await log("pre-disabled: initial state (value=a, section visible)");
    setValue(payment, "card");
    const preDisabled = document.getElementById("shown-pre-disabled");
    const preDisabledSelect = document.getElementById("pre-disabled-select");
    await waitFor(() => !preDisabled.hidden, { label: "pre-disabled section visible" });
    const alwaysDisabled = preDisabled.querySelector("[name=always_disabled]");
    const normalField = preDisabled.querySelector("[name=normal_field]");
    assert.equal(alwaysDisabled.disabled, true, "always_disabled stays disabled");
    assert.equal(normalField.disabled, false, "normal_field is enabled");

    await log("pre-disabled: hide section (value=b)");
    setValue(preDisabledSelect, "b");
    await waitFor(() => preDisabled.hidden, { label: "pre-disabled section hidden" });
    assert.equal(alwaysDisabled.disabled, true, "always_disabled still disabled");
    assert.noAttr(alwaysDisabled, "data-pwc-temporarily-disabled");
    assert.equal(normalField.disabled, true, "normal_field disabled when hidden");
    assert.hasAttr(normalField, "data-pwc-temporarily-disabled");

    await log("pre-disabled: show section again (value=a)");
    setValue(preDisabledSelect, "a");
    await waitFor(() => !preDisabled.hidden, { label: "pre-disabled section visible again" });
    assert.equal(alwaysDisabled.disabled, true, "always_disabled still disabled after re-show");
    assert.equal(normalField.disabled, false, "normal_field re-enabled after re-show");

    await log("done");
  });
</script>
</body>
</html>
