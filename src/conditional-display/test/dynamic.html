<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>conditional-display: dynamic</title>
    <script type="module" src="../../../dist/conditional-display.js"></script>
</head>

<body>

<h1>conditional-display: dynamic</h1>

<h2>Dynamic children</h2>

<select id="method">
    <option value="a" selected>A</option>
    <option value="b">B</option>
</select>

<pwc-shown-if id="dynamic-children" selector="#method" value="a">
    <input name="original" placeholder="Original field">
</pwc-shown-if>

<h2>Dynamic selector</h2>

<select id="select-1">
    <option value="x" selected>X</option>
    <option value="y">Y</option>
</select>

<select id="select-2">
    <option value="x">X</option>
    <option value="y" selected>Y</option>
</select>

<pwc-shown-if id="dynamic-selector" selector="#select-1" value="x">
    <p>Content</p>
</pwc-shown-if>

<script type="module">
  import { run } from "../../../static/test-harness.js";
  import { setValue } from "../../../static/test-helpers.js";

  run(async ({ assert, equal, waitFor, log }) => {

    // --- Dynamic children ---

    const method = document.getElementById("method");
    const section = document.getElementById("dynamic-children");

    await log("dynamic children: initial state (value=a, visible)");
    await waitFor(() => !section.hidden, { label: "section visible" });

    await log("dynamic children: hide section");
    setValue(method, "b");
    await waitFor(() => section.hidden, { label: "section hidden" });

    await log("dynamic children: add input while hidden");
    const added = document.createElement("input");
    added.name = "added";
    added.placeholder = "Added while hidden";
    section.appendChild(added);

    await waitFor(() => added.disabled, { label: "added input gets disabled" });
    assert(added.hasAttribute("data-pwc-temporarily-disabled"), "added input should be marked as temporarily disabled");

    await log("dynamic children: show section again");
    setValue(method, "a");
    await waitFor(() => !section.hidden, { label: "section visible again" });
    equal(added.disabled, false, "added input should be re-enabled");
    equal(section.querySelector("[name=original]").disabled, false, "original input should be re-enabled");

    await log("dynamic children: add input while visible + hidden");
    setValue(method, "a");
    const added2 = document.createElement("input");
    added2.name = "added2";
    section.appendChild(added2);
    await waitFor(() => !added2.disabled, { label: "added2 enabled while visible" });

    setValue(method, "b");
    await waitFor(() => section.hidden, { label: "section hidden again" });
    equal(added2.disabled, true, "added2 should be disabled when hidden");

    // --- Dynamic selector change ---

    const el = document.getElementById("dynamic-selector");

    await log("dynamic selector: initial state (selector=#select-1, value=x, visible)");
    await waitFor(() => !el.hidden, { label: "dynamic-selector visible" });

    await log("dynamic selector: switch selector to #select-2 (value=y, no match)");
    el.setAttribute("selector", "#select-2");
    await waitFor(() => el.hidden, { label: "dynamic-selector hidden after selector change" });

    await log("dynamic selector: change select-2 to x (matches)");
    setValue(document.getElementById("select-2"), "x");
    await waitFor(() => !el.hidden, { label: "dynamic-selector visible after select-2 change" });

    await log("dynamic selector: switch selector back to #select-1 (value=x, matches)");
    el.setAttribute("selector", "#select-1");
    await waitFor(() => !el.hidden, { label: "dynamic-selector visible with select-1" });

    await log("dynamic selector: change select-1 to y (no match)");
    setValue(document.getElementById("select-1"), "y");
    await waitFor(() => el.hidden, { label: "dynamic-selector hidden after select-1 change" });

    await log("done");
  });
</script>
</body>
</html>
